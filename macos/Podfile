platform :osx, '10.14'
# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'
project 'Runner', {
'Debug' => :debug,
'Profile' => :release,
'Release' => :release,
}
def flutter_root
 generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'ephemeral', 'Flutter-Generated.xcconfig'), __FILE__)
unless File.exist?(generated_xcode_build_settings_path)
raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, make sure \"flutter pub get\" is executed first"
end
File.foreach(generated_xcode_build_settings_path) do |line|
 matches = line.match(/FLUTTER_ROOT\=(.*)/)
return matches[1].strip if matches
end
raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Flutter-Generated.xcconfig, then run \"flutter pub get\""
end
require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)
flutter_macos_podfile_setup
target 'Runner' do
 use_frameworks!
 flutter_install_all_macos_pods File.dirname(File.realpath(__FILE__))
 target 'RunnerTests' do
 inherit! :search_paths
end
end

post_install do |installer|
  installer.generated_projects.each do |project|
    project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['ARCHS'] = 'arm64'
        config.build_settings['EXCLUDED_ARCHS'] = 'x86_64 i386'
        config.build_settings['ONLY_ACTIVE_ARCH'] = 'YES'
        
        config.build_settings['MACOSX_DEPLOYMENT_TARGET'] = '10.14'
        
        ['OTHER_CFLAGS', 'OTHER_CPLUSPLUSFLAGS', 'OTHER_LDFLAGS', 'WARNING_CFLAGS'].each do |flag_name|
          if config.build_settings[flag_name]
            if config.build_settings[flag_name].is_a?(String)
              config.build_settings[flag_name] = config.build_settings[flag_name].gsub(/-G\s*/, '')
            elsif config.build_settings[flag_name].is_a?(Array)
              config.build_settings[flag_name] = config.build_settings[flag_name].reject { |flag| flag == '-G' }
            end
          end
        end
      end
    end
  end
  
  installer.pods_project.targets.each do |target|
    flutter_additional_macos_build_settings(target)
    
    if target.name == 'BoringSSL-GRPC' || target.name == 'gRPC-Core' || target.name == 'gRPC-C++' || target.name.include?('abseil')
      puts "Applying special fix for #{target.name}"
      target.build_configurations.each do |config|
        if config.build_settings['OTHER_CFLAGS']
          puts "Fixing OTHER_CFLAGS for #{target.name}"
          if config.build_settings['OTHER_CFLAGS'].is_a?(String)
            config.build_settings['OTHER_CFLAGS'] = config.build_settings['OTHER_CFLAGS'].gsub(/-G(\s|$)/, '')
          elsif config.build_settings['OTHER_CFLAGS'].is_a?(Array)
            config.build_settings['OTHER_CFLAGS'] = config.build_settings['OTHER_CFLAGS'].reject { |flag| flag == '-G' }
          end
        end
        
        if config.build_settings['OTHER_CPLUSPLUSFLAGS']
          puts "Fixing OTHER_CPLUSPLUSFLAGS for #{target.name}"
          if config.build_settings['OTHER_CPLUSPLUSFLAGS'].is_a?(String)
            config.build_settings['OTHER_CPLUSPLUSFLAGS'] = config.build_settings['OTHER_CPLUSPLUSFLAGS'].gsub(/-G(\s|$)/, '')
          elsif config.build_settings['OTHER_CPLUSPLUSFLAGS'].is_a?(Array)
            config.build_settings['OTHER_CPLUSPLUSFLAGS'] = config.build_settings['OTHER_CPLUSPLUSFLAGS'].reject { |flag| flag == '-G' }
          end
        end
      end
    end
  end
  
  begin
    installer.pods_project.targets.each do |target|
      pbxproj_path = installer.pods_project.path.to_s
      if File.exist?(pbxproj_path)
        puts "Directly modifying project file: #{pbxproj_path}"
        content = File.read(pbxproj_path)
        modified_content = content.gsub(/(\s|\\")-G(\s|\\")/, '\1\2')
        File.write(pbxproj_path, modified_content)
        puts "Successfully cleaned -G flags from #{pbxproj_path}"
      end
    end
  rescue => e
    puts "Error modifying project file: #{e.message}"
  end
end
